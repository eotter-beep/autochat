<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Autochat - GPT4All</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura.css" type="text/css">
</head>
<body>
    <header>
        <h1>Autochat</h1>
        <nav>
            <a href="submitting.html">Submit a character</a>
            <a href="https://github.com/eotter-beep/autochat/issues/new">Bug report</a>
        </nav>
    </header>

    <!-- Search box -->
    <div>
        <label for="search">Search characters:</label>
        <input id="search" placeholder="Type to filter characters">
    </div>

    <!-- Character dropdown -->
    <div>
        <label for="character">Choose a character:</label>
        <select id="character"></select>
    </div>

    <!-- Prompt input -->
    <div>
        <input id="prompt" placeholder="Type your prompt here">
        <button id="sendBtn">Send</button>
    </div>

    <!-- Response area -->
    <div id="response" style="margin-top:1em; border:1px solid #ccc; padding:10px; white-space: pre-wrap;"></div>

    <!-- GPT4All.js CDN -->
    <script type="module">
        import { GPT4All } from "https://cdn.jsdelivr.net/npm/gpt4all/dist/gpt4all.min.js";

        const characters = {
            "luna": "You are a sassy cat.",
            "zephyr": "You are a wise old owl who gives thoughtful advice.",
            "nova": "You are a cheerful robot who loves to make people happy."
        };

        const characterSelect = document.getElementById('character');
        const searchInput = document.getElementById('search');
        const sendBtn = document.getElementById('sendBtn');
        const responseDiv = document.getElementById('response');
        const promptInput = document.getElementById('prompt');

        // Populate dropdown
        function populateDropdown(filter = '') {
            const currentValue = characterSelect.value;
            characterSelect.innerHTML = '';
            for (const [key, desc] of Object.entries(characters)) {
                if (key.toLowerCase().includes(filter.toLowerCase()) || desc.toLowerCase().includes(filter.toLowerCase())) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${key} (${desc.split('.')[0]})`;
                    characterSelect.appendChild(option);
                }
            }
            if (Array.from(characterSelect.options).some(opt => opt.value === currentValue)) {
                characterSelect.value = currentValue;
            } else if (characterSelect.options.length > 0) {
                characterSelect.selectedIndex = 0;
            }
        }

        populateDropdown();
        searchInput.addEventListener('input', (e) => populateDropdown(e.target.value));

        // Initialize GPT4All
        let gpt;
        async function initGPT() {
            gpt = new GPT4All({ model: "gpt4all-lora-quantized" }); // CPU-friendly model
            await gpt.init();
            console.log("GPT4All initialized!");
        }
        initGPT();

        // Send chat
        async function sendChat() {
            const selectedCharacter = characterSelect.value;
            const userPrompt = promptInput.value.trim() || "hi";

            if (!selectedCharacter) {
                alert("Select a character!");
                return;
            }

            responseDiv.innerHTML = "Thinking...";

            try {
                const systemPrompt = characters[selectedCharacter];
                const fullPrompt = `${systemPrompt}\nUser: ${userPrompt}\nAI:`;

                const output = await gpt.prompt(fullPrompt, {
                    max_tokens: 200,
                    temperature: 0.7
                });

                responseDiv.innerHTML = output.trim();
                promptInput.value = "";
            } catch (err) {
                console.error(err);
                responseDiv.innerHTML = "Error generating response.";
            }
        }

        sendBtn.addEventListener('click', sendChat);
        promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
    </script>
</body>
</html>
