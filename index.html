<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Autochat - GPT4All</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura.css" type="text/css" />
  <style>
    body { max-width:900px; margin:1.5rem auto; padding:0 1rem; }
    header { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
    nav a { margin-left:0.5rem; }
    .controls { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; margin-top:1rem; }
    .controls > div { min-width:220px; }
    #response { margin-top:1em; border:1px solid #ccc; padding:10px; white-space: pre-wrap; min-height:4rem; }
    #sendBtn[disabled] { opacity:0.6; cursor:not-allowed; }
    label { display:block; margin-bottom:0.25rem; }
  </style>
</head>
<body>
  <header>
    <h1>Autochat</h1>
    <nav>
      <a href="submitting.html">Submit a character</a>
      <a href="https://github.com/eotter-beep/autochat/issues/new" target="_blank" rel="noopener">Bug report</a>
    </nav>
  </header>

  <section style="margin-top:1rem;">
    <div>
      <label for="search">Search characters</label>
      <input id="search" placeholder="Type to filter characters" />
    </div>

    <div style="margin-top:0.5rem;">
      <label for="character">Choose a character</label>
      <select id="character" aria-label="Choose a character"></select>
    </div>

    <div class="controls" style="margin-top:0.5rem;">
      <div style="flex:1; min-width:220px;">
        <label for="prompt" style="visibility:hidden; height:0; margin:0; padding:0;">Prompt</label>
        <input id="prompt" placeholder="Type your prompt here" style="width:100%;" />
      </div>
      <div>
        <button id="sendBtn" disabled>Send</button>
      </div>
    </div>

    <div id="response" role="status" aria-live="polite">Initializing…</div>
  </section>

  <script type="module">
    const GPT4AllModule = require("gpt4all");
    
    const characters = {
      luna: "You are a sassy cat.",
      zephyr: "You are a wise old owl who gives thoughtful advice.",
      nova: "You are a cheerful robot who loves to make people happy."
    };
    
    const characterSelect = document.getElementById("character");
    const searchInput = document.getElementById("search");
    const sendBtn = document.getElementById("sendBtn");
    const responseDiv = document.getElementById("response");
    const promptInput = document.getElementById("prompt");
    
    function populateDropdown(filter = "") {
      const prevValue = characterSelect.value;
      characterSelect.innerHTML = "";
    
      const keys = Object.keys(characters);
      const normalizedFilter = (filter || "").toLowerCase().trim();
    
      const matches = keys.filter((k) => {
        const desc = characters[k] || "";
        return k.toLowerCase().includes(normalizedFilter) || desc.toLowerCase().includes(normalizedFilter);
      });
    
      if (matches.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.disabled = true;
        option.selected = true;
        option.textContent = "No characters match";
        characterSelect.appendChild(option);
        return;
      }
    
      for (const key of matches) {
        const desc = characters[key] || "";
        const option = document.createElement("option");
        option.value = key;
        const shortDesc = desc.split(".").filter(Boolean)[0] || desc;
        option.textContent = `${key} — ${shortDesc}`;
        characterSelect.appendChild(option);
      }
    
      if (prevValue && Array.from(characterSelect.options).some((o) => o.value === prevValue)) {
        characterSelect.value = prevValue;
      } else {
        characterSelect.selectedIndex = 0;
      }
    }
    
    populateDropdown();
    searchInput.addEventListener("input", (e) => populateDropdown(e.target.value));
    
    let gpt = null;
    let modelReady = false;
    
    async function initModel() {
      responseDiv.textContent = "Initializing model… This may take a few seconds.";
      sendBtn.disabled = true;
    
      try {
        const anyMod = GPT4AllModule;
    
        const GPT4AllCtor =
          anyMod.GPT4All || anyMod.default?.GPT4All || anyMod.default || anyMod;
    
        if (typeof GPT4AllCtor === "function") {
          try {
            gpt = new GPT4AllCtor({ model: "gpt4all-lora-quantized" });
          } catch (err) {
            gpt = await GPT4AllCtor({ model: "gpt4all-lora-quantized" });
          }
        } else if (GPT4AllCtor && typeof GPT4AllCtor.create === "function") {
          gpt = await GPT4AllCtor.create({ model: "gpt4all-lora-quantized" });
        } else {
          gpt = GPT4AllCtor;
        }
    
        if (gpt && typeof gpt.init === "function") {
          await gpt.init();
        }
    
        modelReady = true;
        responseDiv.textContent = "Model ready. Choose a character and send a prompt.";
        sendBtn.disabled = false;
      } catch (err) {
        console.error("Model initialization failed:", err);
        responseDiv.textContent = "Failed to initialize model. See console for details.";
        sendBtn.disabled = true;
      }
    }
    
    initModel();
    
    function setResponseText(text) {
      responseDiv.textContent = text;
    }
    
    async function sendChat() {
      if (!modelReady || !gpt) {
        alert("Model is not ready yet. Please wait a moment.");
        return;
      }
    
      const selectedCharacter = characterSelect.value;
      const userPrompt = (promptInput.value || "").trim();
    
      if (!selectedCharacter) {
        alert("Select a character!");
        return;
      }
    
      if (!userPrompt) {
        alert("Please enter a prompt.");
        return;
      }
    
      setResponseText("Thinking...");
    
      try {
        const systemPrompt = characters[selectedCharacter] || "";
        const fullPrompt = `${systemPrompt}\nUser: ${userPrompt}\nAI:`;
    
        let output;
        if (typeof gpt.prompt === "function") {
          output = await gpt.prompt(fullPrompt, { max_tokens: 200, temperature: 0.7 });
        } else if (typeof gpt.generate === "function") {
          output = await gpt.generate(fullPrompt, { max_tokens: 200, temperature: 0.7 });
        } else if (typeof gpt.run === "function") {
          output = await gpt.run(fullPrompt, { max_tokens: 200, temperature: 0.7 });
        } else if (typeof gpt === "function") {
          output = await gpt(fullPrompt, { max_tokens: 200, temperature: 0.7 });
        } else {
          throw new Error("No supported generation method found on model instance");
        }
    
        let text = "";
        if (typeof output === "string") text = output;
        else if (output && typeof output === "object") text = output.text || output.output || output.response || JSON.stringify(output);
        else text = String(output);
    
        setResponseText(text.trim());
        promptInput.value = "";
      } catch (err) {
        console.error("Generation error:", err);
        setResponseText("Error generating response. See console for details.");
      }
    }
    
    sendBtn.addEventListener("click", sendChat);
    promptInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!sendBtn.disabled) sendChat();
      }
    });
    characterSelect.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        promptInput.focus();
      }
    });
  </script>
</body>
</html>
