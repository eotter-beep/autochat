<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Autochat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura.css" type="text/css">
</head>
<body>
    <header>
        <h1>Autochat</h1>
        <nav>
            <a href="submitting.html">Submit a character</a>
            <a href="https://github.com/eotter-beep/autochat/issues/new">Bug report</a>
        </nav>
    </header>

    <!-- Search box -->
    <div>
        <label for="search">Search characters:</label>
        <input id="search" placeholder="Type to filter characters">
    </div>

    <!-- Character dropdown -->
    <div>
        <label for="character">Choose a character:</label>
        <select id="character"></select>
    </div>

    <!-- Prompt input -->
    <div>
        <input id="prompt" placeholder="Type your prompt here">
        <button id="sendBtn">Send</button>
    </div>

    <!-- Response area -->
    <div id="response" style="margin-top:1em; border:1px solid #ccc; padding:10px;"></div>

    <script src="https://js.puter.com/v2/"></script>
    <script>
        const characters = {
            "luna": "You are a sassy cat.",
            "zephyr": "You are a wise old owl who gives thoughtful advice.",
            "nova": "You are a cheerful robot who loves to make people happy."
        };

        const characterSelect = document.getElementById('character');
        const searchInput = document.getElementById('search');
        const sendBtn = document.getElementById('sendBtn');
        const responseDiv = document.getElementById('response');
        const promptInput = document.getElementById('prompt');

        // Populate dropdown and preserve selection
        function populateDropdown(filter = '') {
            const currentValue = characterSelect.value;
            characterSelect.innerHTML = '';

            for (const [key, desc] of Object.entries(characters)) {
                if (
                    key.toLowerCase().includes(filter.toLowerCase()) ||
                    desc.toLowerCase().includes(filter.toLowerCase())
                ) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${key} (${desc.split('.')[0]})`;
                    characterSelect.appendChild(option);
                }
            }

            // Restore previous selection if possible
            if (Array.from(characterSelect.options).some(opt => opt.value === currentValue)) {
                characterSelect.value = currentValue;
            } else if (characterSelect.options.length > 0) {
                characterSelect.selectedIndex = 0;
            }
        }

        // Initial population
        populateDropdown();

        // Filter on search
        searchInput.addEventListener('input', (e) => {
            populateDropdown(e.target.value);
        });

        // Stream response
        async function streamResponse() {
            const selectedCharacter = characterSelect.value;
            const userPrompt = promptInput.value.trim() || "hi";
        
            if (!selectedCharacter) {
                alert("Select a character!");
                return;
            }
        
            responseDiv.innerHTML = "";
        
            try {
                const response = await puter.ai.chat({
                    model: 'openrouter:meta-llama/llama-3.1-8b-instruct',
                    stream: true, // leave true, but handle non-stream fallback
                    messages: [
                        { role: "system", content: characters[selectedCharacter] },
                        { role: "user", content: userPrompt }
                    ]
                });
        
                // Check if streaming is supported
                if (response && typeof response[Symbol.asyncIterator] === "function") {
                    for await (const part of response) {
                        if (part?.text) responseDiv.innerHTML += part.text;
                    }
                } else if (response?.text) {
                    // fallback if response is a single object with .text
                    responseDiv.innerHTML = response.text;
                } else {
                    console.error(response);
                    responseDiv.innerHTML = "Unexpected API response format.";
                }
        
                promptInput.value = "";
            } catch (err) {
                console.error(err);
                responseDiv.innerHTML = "Error generating response. Check console.";
            }
        }

        sendBtn.addEventListener('click', streamResponse);

        // Optional: press Enter to send
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') streamResponse();
        });
    </script>
</body>
</html>
